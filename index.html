<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DiddyFlow - Pomodoro Timer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-light: #fef6f0;
            --bg-dark: #1a1614;
            --primary: #ff6b4a;
            --primary-dark: #e85535;
            --secondary: #ffb088;
            --accent: #ffd4b8;
            --text-light: #2d2422;
            --text-dark: #f5ebe4;
            --card-light: #ffffff;
            --card-dark: #2d2422;
            --border-light: #ffe5d4;
            --border-dark: #443d3a;
            --success: #4caf50;
            --break-color: #4a9eff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg-light);
            color: var(--text-light);
            min-height: 100vh;
            overflow-x: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }

        body.dark {
            background: var(--bg-dark);
            color: var(--text-dark);
        }

        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background:
                radial-gradient(circle at 20% 50%, rgba(255, 107, 74, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 176, 136, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(255, 212, 184, 0.1) 0%, transparent 50%);
            animation: gradientShift 20s ease infinite;
            pointer-events: none;
            z-index: 0;
        }

        body.dark::before {
            background:
                radial-gradient(circle at 20% 50%, rgba(255, 107, 74, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 176, 136, 0.08) 0%, transparent 50%);
        }

        @keyframes gradientShift {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(-5%, -5%) rotate(5deg); }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
            animation: fadeInDown 0.6s ease;
        }

        h1 {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        .tagline {
            font-size: 1.1rem;
            opacity: 0.7;
            font-family: 'Space Mono', monospace;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 968px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--card-light);
            border-radius: 24px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border-light);
            animation: fadeInUp 0.6s ease;
            transition: all 0.3s ease;
        }

        body.dark .card {
            background: var(--card-dark);
            border-color: var(--border-dark);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 48px rgba(255, 107, 74, 0.15);
        }

        .timer-card {
            text-align: center;
        }

        .mode-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: var(--bg-light);
            padding: 0.5rem;
            border-radius: 16px;
        }

        body.dark .mode-tabs {
            background: var(--bg-dark);
        }

        .mode-tab {
            flex: 1;
            padding: 0.75rem 1rem;
            border: none;
            background: transparent;
            color: var(--text-light);
            cursor: pointer;
            border-radius: 12px;
            font-family: 'DM Sans', sans-serif;
            font-weight: 500;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        body.dark .mode-tab {
            color: var(--text-dark);
        }

        .mode-tab.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 107, 74, 0.3);
        }

        .timer-display {
            font-family: 'Space Mono', monospace;
            font-size: 6rem;
            font-weight: 700;
            margin: 2rem 0;
            color: var(--primary);
            line-height: 1;
            text-shadow: 0 2px 8px rgba(255, 107, 74, 0.2);
        }

        .timer-progress {
            width: 100%;
            height: 8px;
            background: var(--border-light);
            border-radius: 999px;
            overflow: hidden;
            margin-bottom: 2rem;
        }

        body.dark .timer-progress {
            background: var(--border-dark);
        }

        .timer-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 999px;
            transition: width 1s linear;
            box-shadow: 0 0 12px rgba(255, 107, 74, 0.5);
        }

        .timer-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 16px;
            font-family: 'DM Sans', sans-serif;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            min-width: 140px;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            box-shadow: 0 6px 20px rgba(255, 107, 74, 0.3);
        }

        .btn-secondary {
            background: var(--card-light);
            color: var(--text-light);
            border: 2px solid var(--border-light);
        }

        body.dark .btn-secondary {
            background: var(--card-dark);
            color: var(--text-dark);
            border-color: var(--border-dark);
        }

        .btn-secondary:hover {
            border-color: var(--primary);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .stat-item {
            text-align: center;
            padding: 1rem;
            background: var(--bg-light);
            border-radius: 12px;
        }

        body.dark .stat-item {
            background: var(--bg-dark);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            font-family: 'Space Mono', monospace;
        }

        .stat-label {
            font-size: 0.85rem;
            opacity: 0.7;
            margin-top: 0.25rem;
        }

        .settings-grid {
            display: grid;
            gap: 1.5rem;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--bg-light);
            border-radius: 12px;
        }

        body.dark .setting-item {
            background: var(--bg-dark);
        }

        .setting-label {
            font-weight: 500;
        }

        .setting-input {
            width: 80px;
            padding: 0.5rem;
            border: 2px solid var(--border-light);
            border-radius: 8px;
            font-family: 'Space Mono', monospace;
            font-size: 1rem;
            text-align: center;
            background: var(--card-light);
            color: var(--text-light);
        }

        body.dark .setting-input {
            background: var(--card-dark);
            color: var(--text-dark);
            border-color: var(--border-dark);
        }

        .setting-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .calendar-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .calendar-nav {
            display: flex;
            gap: 0.5rem;
        }

        .calendar-nav button {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--bg-light);
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        body.dark .calendar-nav button {
            background: var(--bg-dark);
        }

        .calendar-nav button:hover {
            background: var(--primary);
            color: white;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .calendar-day-label {
            text-align: center;
            font-size: 0.85rem;
            font-weight: 600;
            opacity: 0.6;
            padding: 0.5rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg-light);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            font-family: 'Space Mono', monospace;
        }

        body.dark .calendar-day {
            background: var(--bg-dark);
        }

        .calendar-day:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.05);
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        .calendar-day.today {
            background: var(--primary);
            color: white;
            font-weight: 700;
        }

        .calendar-day.selected {
            border: 2px solid var(--primary);
        }

        .calendar-day.has-tasks::after {
            content: '';
            position: absolute;
            bottom: 4px;
            width: 4px;
            height: 4px;
            background: var(--primary);
            border-radius: 50%;
        }

        .calendar-day.has-tasks.today::after {
            background: white;
        }

        .task-input-section {
            margin-bottom: 1.5rem;
        }

        .task-input-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .task-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-light);
            border-radius: 12px;
            font-family: 'DM Sans', sans-serif;
            font-size: 1rem;
            background: var(--card-light);
            color: var(--text-light);
        }

        body.dark .task-input {
            background: var(--card-dark);
            color: var(--text-dark);
            border-color: var(--border-dark);
        }

        .task-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn-add {
            padding: 0.75rem 1.5rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-add:hover {
            background: var(--primary-dark);
        }

        .date-display {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-top: 0.25rem;
        }

        .task-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .task-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: var(--bg-light);
            border-radius: 12px;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
            animation: slideIn 0.3s ease;
        }

        body.dark .task-item {
            background: var(--bg-dark);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .task-item:hover {
            transform: translateX(4px);
        }

        .task-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .task-text {
            flex: 1;
            font-size: 0.95rem;
        }

        .task-item.completed .task-text {
            text-decoration: line-through;
            opacity: 0.5;
        }

        .task-date {
            font-size: 0.8rem;
            opacity: 0.6;
            font-family: 'Space Mono', monospace;
        }

        .task-delete {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .task-delete:hover {
            background: #ff4444;
            color: white;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-light);
            padding: 2rem;
            border-radius: 24px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalPop 0.3s ease;
        }

        body.dark .modal-content {
            background: var(--card-dark);
        }

        @keyframes modalPop {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .modal-text {
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .session-indicator {
            display: inline-block;
            padding: 0.5rem 1rem;
            background: var(--bg-light);
            border-radius: 12px;
            font-family: 'Space Mono', monospace;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        body.dark .session-indicator {
            background: var(--bg-dark);
        }

        .auto-start-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: var(--border-light);
            border-radius: 999px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        body.dark .toggle-switch {
            background: var(--border-dark);
        }

        .toggle-switch.active {
            background: var(--primary);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        .toggle-switch.active::after {
            transform: translateX(24px);
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }

            .timer-display {
                font-size: 4rem;
            }

            .stats {
                grid-template-columns: 1fr;
            }

            .calendar-day {
                font-size: 0.9rem;
            }

            .container {
                padding: 1rem;
            }
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            opacity: 0.5;
        }

        .task-filter {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--border-light);
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        body.dark .filter-btn {
            border-color: var(--border-dark);
        }

        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--card-dark);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            animation: slideInRight 0.3s ease;
            display: none;
        }

        .toast.show {
            display: block;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üçÖ DiddyFlow</h1>
            <p class="tagline">Pomodoro Timer + Task Manager</p>
        </header>

        <div class="main-grid">
            <!-- Timer Section -->
            <div class="card timer-card">
                <div class="mode-tabs">
                    <button class="mode-tab active" data-mode="pomodoro">Pomodoro</button>
                    <button class="mode-tab" data-mode="short">Short Break</button>
                    <button class="mode-tab" data-mode="long">Long Break</button>
                </div>

                <div class="session-indicator">
                    Session <span id="sessionCount">1</span> / <span id="sessionMax">4</span>
                </div>

                <div class="timer-display" id="timerDisplay">25:00</div>

                <div class="timer-progress">
                    <div class="timer-progress-bar" id="progressBar" style="width: 100%"></div>
                </div>

                <div class="timer-controls">
                    <button class="btn btn-primary" id="startBtn">Start</button>
                    <button class="btn btn-secondary" id="resetBtn">Reset</button>
                </div>

                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-value" id="completedSessions">0</div>
                        <div class="stat-label">Completed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalMinutes">0</div>
                        <div class="stat-label">Minutes</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="streakCount">0</div>
                        <div class="stat-label">Streak</div>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div class="card">
                <h2 class="section-title">‚öôÔ∏è Settings</h2>
                <div class="settings-grid">
                    <div class="setting-item">
                        <span class="setting-label">Pomodoro (min)</span>
                        <input type="number" class="setting-input" id="pomodoroTime" value="25" min="1" max="60">
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Short Break (min)</span>
                        <input type="number" class="setting-input" id="shortBreakTime" value="5" min="1" max="30">
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Long Break (min)</span>
                        <input type="number" class="setting-input" id="longBreakTime" value="15" min="1" max="60">
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Auto-start next session</span>
                        <div class="auto-start-toggle">
                            <div class="toggle-switch" id="autoStartToggle"></div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Sessions until long break</span>
                        <input type="number" class="setting-input" id="longBreakInterval" value="4" min="2" max="8">
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar and Tasks Section -->
        <div class="main-grid">
            <!-- Calendar -->
            <div class="card">
                <div class="calendar-header">
                    <h2 class="calendar-title" id="calendarTitle">January 2024</h2>
                    <div class="calendar-nav">
                        <button id="prevMonth">‚Üê</button>
                        <button id="nextMonth">‚Üí</button>
                    </div>
                </div>

                <div class="calendar-grid">
                    <div class="calendar-day-label">Sun</div>
                    <div class="calendar-day-label">Mon</div>
                    <div class="calendar-day-label">Tue</div>
                    <div class="calendar-day-label">Wed</div>
                    <div class="calendar-day-label">Thu</div>
                    <div class="calendar-day-label">Fri</div>
                    <div class="calendar-day-label">Sat</div>
                </div>

                <div class="calendar-grid" id="calendarDays"></div>
            </div>

            <!-- Tasks -->
            <div class="card">
                <h2 class="section-title">üìù Tasks</h2>

                <div class="task-input-section">
                    <div class="task-input-row">
                        <input type="text" class="task-input" id="taskInput" placeholder="Add a task...">
                        <button class="btn-add" id="addTaskBtn">Add</button>
                    </div>
                    <div class="date-display" id="selectedDate">Today</div>
                </div>

                <div class="task-filter">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="today">Today</button>
                    <button class="filter-btn" data-filter="upcoming">Upcoming</button>
                    <button class="filter-btn" data-filter="completed">Completed</button>
                </div>

                <div class="task-list" id="taskList">
                    <div class="empty-state">No tasks yet. Add one above!</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for notifications -->
    <div class="modal" id="notificationModal">
        <div class="modal-content">
            <h3 class="modal-title" id="modalTitle">Time's Up!</h3>
            <p class="modal-text" id="modalText">Great work! Time for a break.</p>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="modalClose">Close</button>
                <button class="btn btn-primary" id="modalStart">Start Next</button>
            </div>
        </div>
    </div>

    <!-- Toast notification -->
    <div class="toast" id="toast"></div>

    <script>
        // Always use dark mode
        document.documentElement.classList.add('dark');
        document.body.classList.add('dark');

        // IndexedDB for persistent storage (localStorage not available in iframe)
        let db;
        const DB_NAME = 'DiddyFlowDB';
        const DB_VERSION = 1;

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains('appData')) {
                        db.createObjectStore('appData', { keyPath: 'key' });
                    }
                };
            });
        }

        async function saveData(key, value) {
            if (!db) return;
            try {
                const tx = db.transaction(['appData'], 'readwrite');
                const store = tx.objectStore('appData');
                await store.put({ key, value });
            } catch (e) {
                console.error('Failed to save data:', e);
            }
        }

        async function loadData(key, defaultValue) {
            if (!db) return defaultValue;
            try {
                const tx = db.transaction(['appData'], 'readonly');
                const store = tx.objectStore('appData');
                const request = store.get(key);
                return new Promise((resolve) => {
                    request.onsuccess = () => {
                        resolve(request.result ? request.result.value : defaultValue);
                    };
                    request.onerror = () => resolve(defaultValue);
                });
            } catch (e) {
                console.error('Failed to load data:', e);
                return defaultValue;
            }
        }

        // State
        let currentMode = 'pomodoro';
        let timeLeft = 25 * 60;
        let totalTime = 25 * 60;
        let isRunning = false;
        let interval = null;
        let sessionCount = 1;
        let completedSessions = 0;
        let totalMinutes = 0;
        let streak = 0;
        let autoStart = false;

        // Calendar state
        let currentDate = new Date();
        let selectedDate = new Date();
        selectedDate.setHours(0, 0, 0, 0);

        // Tasks state
        let tasks = [];
        let taskFilter = 'all';

        // Elements
        const timerDisplay = document.getElementById('timerDisplay');
        const progressBar = document.getElementById('progressBar');
        const startBtn = document.getElementById('startBtn');
        const resetBtn = document.getElementById('resetBtn');
        const modeTabs = document.querySelectorAll('.mode-tab');
        const sessionCountEl = document.getElementById('sessionCount');
        const sessionMaxEl = document.getElementById('sessionMax');
        const completedSessionsEl = document.getElementById('completedSessions');
        const totalMinutesEl = document.getElementById('totalMinutes');
        const streakCountEl = document.getElementById('streakCount');
        const pomodoroTimeInput = document.getElementById('pomodoroTime');
        const shortBreakTimeInput = document.getElementById('shortBreakTime');
        const longBreakTimeInput = document.getElementById('longBreakTime');
        const longBreakIntervalInput = document.getElementById('longBreakInterval');
        const autoStartToggle = document.getElementById('autoStartToggle');
        const calendarTitle = document.getElementById('calendarTitle');
        const calendarDays = document.getElementById('calendarDays');
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');
        const taskInput = document.getElementById('taskInput');
        const addTaskBtn = document.getElementById('addTaskBtn');
        const taskList = document.getElementById('taskList');
        const selectedDateEl = document.getElementById('selectedDate');
        const filterBtns = document.querySelectorAll('.filter-btn');
        const notificationModal = document.getElementById('notificationModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalText = document.getElementById('modalText');
        const modalClose = document.getElementById('modalClose');
        const modalStart = document.getElementById('modalStart');
        const toast = document.getElementById('toast');

        // Timer functions
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function updateDisplay() {
            timerDisplay.textContent = formatTime(timeLeft);
            const progress = (timeLeft / totalTime) * 100;
            progressBar.style.width = `${progress}%`;
        }

        function updateStats() {
            completedSessionsEl.textContent = completedSessions;
            totalMinutesEl.textContent = totalMinutes;
            streakCountEl.textContent = streak;

            // Save stats to IndexedDB
            saveData('completedSessions', completedSessions);
            saveData('totalMinutes', totalMinutes);
            saveData('streak', streak);
        }

        function startTimer() {
            if (!isRunning) {
                isRunning = true;
                startBtn.textContent = 'Pause';

                interval = setInterval(() => {
                    timeLeft--;
                    updateDisplay();

                    if (timeLeft <= 0) {
                        clearInterval(interval);
                        isRunning = false;
                        startBtn.textContent = 'Start';
                        onTimerComplete();
                    }
                }, 1000);
            } else {
                isRunning = false;
                startBtn.textContent = 'Start';
                clearInterval(interval);
            }
        }

        function resetTimer() {
            clearInterval(interval);
            isRunning = false;
            startBtn.textContent = 'Start';

            switch(currentMode) {
                case 'pomodoro':
                    timeLeft = parseInt(pomodoroTimeInput.value) * 60;
                    break;
                case 'short':
                    timeLeft = parseInt(shortBreakTimeInput.value) * 60;
                    break;
                case 'long':
                    timeLeft = parseInt(longBreakTimeInput.value) * 60;
                    break;
            }

            totalTime = timeLeft;
            updateDisplay();
        }

        function switchMode(mode) {
            currentMode = mode;
            modeTabs.forEach(tab => {
                if (tab.dataset.mode === mode) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            resetTimer();
        }

        function onTimerComplete() {
            playNotificationSound();

            if (currentMode === 'pomodoro') {
                completedSessions++;
                totalMinutes += parseInt(pomodoroTimeInput.value);
                streak++;
                updateStats();

                sessionCount++;
                sessionCountEl.textContent = sessionCount;
                saveData('sessionCount', sessionCount);

                const longBreakInterval = parseInt(longBreakIntervalInput.value);
                if ((sessionCount - 1) % longBreakInterval === 0 && sessionCount > 1) {
                    showNotification('Time for a long break!', 'You\'ve completed ' + longBreakInterval + ' sessions. Take a longer break!', 'long');
                } else {
                    showNotification('Time for a short break!', 'Great work! Take a short break.', 'short');
                }
            } else {
                showNotification('Break finished!', 'Ready to get back to work?', 'pomodoro');
            }
        }

        function showNotification(title, text, nextMode) {
            modalTitle.textContent = title;
            modalText.textContent = text;
            notificationModal.classList.add('active');

            modalStart.onclick = () => {
                switchMode(nextMode);
                notificationModal.classList.remove('active');
                if (autoStart) {
                    startTimer();
                }
            };
        }

        function playNotificationSound() {
            // Create a simple beep sound using Web Audio API
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = 800;
            oscillator.type = 'sine';

            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        function showToast(message) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Calendar functions
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            calendarTitle.textContent = `${monthNames[month]} ${year}`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const prevLastDay = new Date(year, month, 0);

            const firstDayIndex = firstDay.getDay();
            const lastDayDate = lastDay.getDate();
            const prevLastDayDate = prevLastDay.getDate();

            calendarDays.innerHTML = '';

            // Previous month days
            for (let i = firstDayIndex; i > 0; i--) {
                const day = document.createElement('div');
                day.className = 'calendar-day other-month';
                day.textContent = prevLastDayDate - i + 1;
                calendarDays.appendChild(day);
            }

            // Current month days
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let i = 1; i <= lastDayDate; i++) {
                const day = document.createElement('div');
                day.className = 'calendar-day';
                day.textContent = i;

                const currentDayDate = new Date(year, month, i);
                currentDayDate.setHours(0, 0, 0, 0);

                if (currentDayDate.getTime() === today.getTime()) {
                    day.classList.add('today');
                }

                if (currentDayDate.getTime() === selectedDate.getTime()) {
                    day.classList.add('selected');
                }

                // Check if this day has tasks
                const tasksForDay = tasks.filter(task => {
                    const taskDate = new Date(task.date);
                    return taskDate.getTime() === currentDayDate.getTime();
                });

                if (tasksForDay.length > 0) {
                    day.classList.add('has-tasks');
                }

                day.addEventListener('click', () => {
                    selectedDate = currentDayDate;
                    renderCalendar();
                    updateSelectedDateDisplay();
                    renderTasks();
                });

                calendarDays.appendChild(day);
            }

            // Next month days
            const remainingDays = 42 - calendarDays.children.length;
            for (let i = 1; i <= remainingDays; i++) {
                const day = document.createElement('div');
                day.className = 'calendar-day other-month';
                day.textContent = i;
                calendarDays.appendChild(day);
            }
        }

        function updateSelectedDateDisplay() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (selectedDate.getTime() === today.getTime()) {
                selectedDateEl.textContent = 'Today';
            } else {
                const options = { weekday: 'short', month: 'short', day: 'numeric' };
                selectedDateEl.textContent = selectedDate.toLocaleDateString('en-US', options);
            }
        }

        // Task functions
        function addTask() {
            const text = taskInput.value.trim();
            if (!text) return;

            const task = {
                id: Date.now(),
                text: text,
                date: selectedDate.getTime(),
                completed: false,
                createdAt: Date.now()
            };

            tasks.push(task);
            taskInput.value = '';
            saveData('tasks', tasks);
            renderTasks();
            renderCalendar();
            showToast('Task added!');
        }

        function toggleTask(id) {
            const task = tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                saveData('tasks', tasks);
                renderTasks();
            }
        }

        function deleteTask(id) {
            tasks = tasks.filter(t => t.id !== id);
            saveData('tasks', tasks);
            renderTasks();
            renderCalendar();
            showToast('Task deleted!');
        }

        function renderTasks() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let filteredTasks = tasks;

            switch(taskFilter) {
                case 'today':
                    filteredTasks = tasks.filter(task => {
                        const taskDate = new Date(task.date);
                        return taskDate.getTime() === today.getTime();
                    });
                    break;
                case 'upcoming':
                    filteredTasks = tasks.filter(task => {
                        const taskDate = new Date(task.date);
                        return taskDate.getTime() > today.getTime() && !task.completed;
                    });
                    break;
                case 'completed':
                    filteredTasks = tasks.filter(task => task.completed);
                    break;
            }

            // Sort by date, then by creation time
            filteredTasks.sort((a, b) => {
                if (a.date !== b.date) {
                    return a.date - b.date;
                }
                return a.createdAt - b.createdAt;
            });

            if (filteredTasks.length === 0) {
                taskList.innerHTML = '<div class="empty-state">No tasks found.</div>';
                return;
            }

            taskList.innerHTML = filteredTasks.map(task => {
                const taskDate = new Date(task.date);
                const dateStr = taskDate.getTime() === today.getTime()
                    ? 'Today'
                    : taskDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                return `
                    <div class="task-item ${task.completed ? 'completed' : ''}">
                        <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''}
                               onchange="toggleTask(${task.id})">
                        <span class="task-text">${task.text}</span>
                        <span class="task-date">${dateStr}</span>
                        <button class="task-delete" onclick="deleteTask(${task.id})">‚úï</button>
                    </div>
                `;
            }).join('');
        }

        // Event listeners
        startBtn.addEventListener('click', startTimer);
        resetBtn.addEventListener('click', resetTimer);

        modeTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                if (isRunning) {
                    clearInterval(interval);
                    isRunning = false;
                    startBtn.textContent = 'Start';
                }
                switchMode(tab.dataset.mode);
            });
        });

        pomodoroTimeInput.addEventListener('change', () => {
            if (currentMode === 'pomodoro') resetTimer();
        });

        shortBreakTimeInput.addEventListener('change', () => {
            if (currentMode === 'short') resetTimer();
        });

        longBreakTimeInput.addEventListener('change', () => {
            if (currentMode === 'long') resetTimer();
        });

        longBreakIntervalInput.addEventListener('change', () => {
            sessionMaxEl.textContent = longBreakIntervalInput.value;
        });

        autoStartToggle.addEventListener('click', () => {
            autoStart = !autoStart;
            autoStartToggle.classList.toggle('active');
            saveData('autoStart', autoStart);
        });

        prevMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });

        nextMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });

        addTaskBtn.addEventListener('click', addTask);

        taskInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addTask();
            }
        });

        filterBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                filterBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                taskFilter = btn.dataset.filter;
                renderTasks();
            });
        });

        modalClose.addEventListener('click', () => {
            notificationModal.classList.remove('active');
        });

        // Make functions global for onclick handlers
        window.toggleTask = toggleTask;
        window.deleteTask = deleteTask;

        // Initialize app
        async function initApp() {
            // Initialize IndexedDB
            await initDB();

            // Load saved data
            sessionCount = await loadData('sessionCount', 1);
            completedSessions = await loadData('completedSessions', 0);
            totalMinutes = await loadData('totalMinutes', 0);
            streak = await loadData('streak', 0);
            autoStart = await loadData('autoStart', false);
            tasks = await loadData('tasks', []);

            // Update UI with loaded data
            sessionCountEl.textContent = sessionCount;
            if (autoStart) {
                autoStartToggle.classList.add('active');
            }

            updateDisplay();
            updateStats();
            renderCalendar();
            updateSelectedDateDisplay();
            renderTasks();
        }

        // Start the app
        initApp();
    </script>
</body>
</html>
